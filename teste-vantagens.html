<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Vantagens Universal</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .input-group { display: flex; gap: 10px; margin: 20px 0; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .vantagem-item { padding: 15px; margin: 10px 0; background: #f8f9fa; border-left: 4px solid #28a745; border-radius: 4px; }
        .codigo { font-weight: bold; color: #007bff; font-size: 1.1em; }
        .graduacao { background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em; margin-left: 10px; }
        .debug { background: #e9ecef; padding: 15px; border-radius: 4px; margin-top: 20px; font-family: monospace; font-size: 12px; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; }
        .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste - Vantagens Universal</h1>
        
        <div class="input-group">
            <input type="text" id="fichaIdInput" placeholder="Cole o ID da ficha..." value="lwKW8mjWmw4NcvRhLS5r" />
            <button id="buscarBtn">Buscar Vantagens</button>
        </div>

        <div id="resultado"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBzdrAtJoBUONdyHsEPrzWDTH9FMg1xW78",
            authDomain: "supernova-372bf.firebaseapp.com",
            projectId: "supernova-372bf",
            storageBucket: "supernova-372bf.firebasestorage.app",
            messagingSenderId: "917055386010",
            appId: "1:917055386010:web:3f27d9173e3dd7fbdf8a23"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            auth.signInAnonymously().catch(console.error);
            document.getElementById('buscarBtn').addEventListener('click', buscarVantagens);
        });

        async function buscarVantagens() {
            const fichaId = document.getElementById('fichaIdInput').value.trim();
            const resultado = document.getElementById('resultado');
            
            if (!fichaId) {
                resultado.innerHTML = '<div class="error">‚ùå Insira um ID da ficha</div>';
                return;
            }

            resultado.innerHTML = '<div>üîç Carregando...</div>';

            try {
                const fichaDoc = await db.collection('fichas').doc(fichaId).get();
                
                if (!fichaDoc.exists) {
                    resultado.innerHTML = '<div class="error">‚ùå Ficha n√£o encontrada</div>';
                    return;
                }

                const fichaData = fichaDoc.data();
                let vantagensCodes = [];
                let vantagensGraduacao = {};
                let debugInfo = `üìä <strong>AN√ÅLISE DA ESTRUTURA:</strong>\n`;

                // üéØ DETECTAR E PROCESSAR QUALQUER ESTRUTURA
                if (fichaData.vantagens) {
                    const tipo = typeof fichaData.vantagens;
                    debugInfo += `üîç Tipo do campo 'vantagens': ${tipo}\n`;

                    if (tipo === 'string') {
                        // String JSON - tentar converter
                        debugInfo += `‚ö†Ô∏è ESTRUTURA: String JSON\n`;
                        try {
                            const parsed = JSON.parse(fichaData.vantagens);
                            if (Array.isArray(parsed)) {
                                vantagensCodes = parsed;
                                vantagensGraduacao = Object.fromEntries(parsed.map(code => [code, 0]));
                            } else if (typeof parsed === 'object') {
                                vantagensCodes = Object.keys(parsed);
                                vantagensGraduacao = parsed;
                            }
                            debugInfo += `‚úÖ Convertido: ${JSON.stringify(parsed)}\n`;
                        } catch (e) {
                            debugInfo += `‚ùå Erro na convers√£o: ${e.message}\n`;
                        }
                    } 
                    else if (Array.isArray(fichaData.vantagens)) {
                        // Array direto
                        debugInfo += `‚úÖ ESTRUTURA: Array\n`;
                        vantagensCodes = fichaData.vantagens;
                        vantagensGraduacao = Object.fromEntries(fichaData.vantagens.map(code => [code, 0]));
                    } 
                    else if (tipo === 'object') {
                        // Objeto/MAP
                        debugInfo += `‚úÖ ESTRUTURA: Objeto/Map\n`;
                        vantagensCodes = Object.keys(fichaData.vantagens);
                        vantagensGraduacao = fichaData.vantagens;
                    }
                }

                debugInfo += `\nüéØ <strong>C√ìDIGOS DETECTADOS:</strong> ${vantagensCodes.join(', ') || 'Nenhum'}\n`;
                debugInfo += `üìà <strong>GRADUA√á√ïES:</strong> ${JSON.stringify(vantagensGraduacao)}\n`;

                // Buscar detalhes das vantagens
                if (vantagensCodes.length > 0) {
                    const vantagensDetalhes = [];
                    
                    for (const codigo of vantagensCodes) {
                        try {
                            const vantagemDoc = await db.collection('vantagens').doc(codigo).get();
                            if (vantagemDoc.exists) {
                                vantagensDetalhes.push({
                                    codigo: codigo,
                                    data: vantagemDoc.data(),
                                    graduacao: vantagensGraduacao[codigo] || 0
                                });
                                debugInfo += `‚úÖ ${codigo}: Encontrada\n`;
                            } else {
                                debugInfo += `‚ùå ${codigo}: N√£o encontrada na cole√ß√£o\n`;
                            }
                        } catch (error) {
                            debugInfo += `‚ùå ${codigo}: Erro - ${error.message}\n`;
                        }
                    }

                    // Mostrar vantagens
                    let html = `<div class="success">‚úÖ ${vantagensDetalhes.length} vantagens encontradas</div>`;
                    
                    vantagensDetalhes.forEach(vantagem => {
                        const graduacaoHTML = vantagem.graduacao > 0 ? 
                            `<span class="graduacao">Gradua√ß√£o ${vantagem.graduacao}</span>` : '';
                        
                        html += `
                            <div class="vantagem-item">
                                <div class="codigo">${vantagem.codigo}</div>
                                <div><strong>${vantagem.data.nome}</strong> ${graduacaoHTML}</div>
                                <div>${vantagem.data.descricao}</div>
                                <div><small>Categoria: ${vantagem.data.categoria} | Gradu√°vel: ${vantagem.data.graduacao ? 'Sim' : 'N√£o'}</small></div>
                            </div>
                        `;
                    });

                    resultado.innerHTML = html + `<div class="debug">${debugInfo.replace(/\n/g, '<br>')}</div>`;
                } else {
                    resultado.innerHTML = `<div class="error">‚ùå Nenhuma vantagem encontrada</div><div class="debug">${debugInfo.replace(/\n/g, '<br>')}</div>`;
                }

            } catch (error) {
                resultado.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>