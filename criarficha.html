<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supernova RPG - Criar Herói</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #6C63FF;
            --primary-dark: #5a52d5;
            --secondary: #FF6584;
            --dark: #2A2D3E;
            --darker: #1F2232;
            --light: #F5F5F7;
            --success: #4CAF50;
            --error: #f44336;
            --warning: #ff9800;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 2rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }

        .back-btn {
            background: rgba(108, 99, 255, 0.2);
            border: 1px solid var(--primary);
            color: var(--light);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: var(--primary);
        }

        .page-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .page-title p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
        }

        .creation-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        /* Sistema de Abas */
        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            min-width: 120px;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Formulários */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
        }

        .input-with-icon input, 
        .input-with-icon select,
        .input-with-icon textarea {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-with-icon textarea {
            min-height: 100px;
            resize: vertical;
        }

        .input-with-icon input:focus,
        .input-with-icon select:focus,
        .input-with-icon textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.3);
        }

        .input-with-icon select option {
            background: var(--darker);
            color: white;
        }

        /* Descrições */
        .description-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            border-left: 4px solid var(--primary);
        }

        /* Atributos Base */
        .base-attributes {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
            text-align: center;
            border: 1px solid var(--glass-border);
        }

        .attributes-info {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .age-modifier {
            color: var(--primary);
            font-weight: 600;
        }

        /* Ações */
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: space-between;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 99, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--success);
            color: #a5d6a7;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid var(--error);
            color: #ef9a9a;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .nav-buttons {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-star"></i>
                <h1>SUPERNOVA RPG</h1>
            </div>
            <a href="fichas.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </header>

        <div class="page-title">
            <h2>Criar Novo Herói</h2>
            <p>Desenvolva seu personagem passo a passo</p>
        </div>

        <div class="message" id="message"></div>

        <div class="creation-card">
            <!-- Sistema de Abas - APENAS IDENTIDADE E ORIGEM -->
            <div class="tabs">
                <div class="tab active" data-tab="identidade">Identidade</div>
                <div class="tab" data-tab="origem">Origem</div>
            </div>

            <!-- ABA 1: IDENTIDADE -->
            <div class="tab-content active" id="identidade-tab">
                <h3 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-id-card"></i> Identidade do Herói
                </h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="character-name">Nome do Herói *</label>
                        <div class="input-with-icon">
                            <i class="fas fa-mask"></i>
                            <input type="text" id="character-name" placeholder="Ex: Capitão América" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="alter-ego">Alter Ego</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user-secret"></i>
                            <input type="text" id="alter-ego" placeholder="Ex: Steve Rogers">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="character-age">Idade *</label>
                        <div class="input-with-icon">
                            <i class="fas fa-birthday-cake"></i>
                            <input type="number" id="character-age" min="1" max="100" value="25" required>
                        </div>
                    </div>
                </div>

                <div class="base-attributes">
                    <div class="attributes-info">
                        <strong>Atributos Base:</strong> Todos começam em <span class="age-modifier" id="base-value">0</span>
                    </div>
                    <div class="description-box">
                        <strong>Modificador por Idade:</strong> <span id="age-description">+0 (18-69 anos)</span>
                        <br><br>
                        <strong>Atributos que serão registrados:</strong>
                        <br>Força, Agilidade, Luta, Prontidão, Vigor, Destreza, Intelecto, Presença
                    </div>
                </div>

                <div class="actions">
                    <div class="nav-buttons">
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button class="btn btn-primary" id="next-to-origem">
                            Próximo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ABA 2: ORIGEM -->
            <div class="tab-content" id="origem-tab">
                <h3 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-dna"></i> Origem dos Poderes
                </h3>
                
                <div class="form-group">
                    <label for="power-origin">Origem *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-bolt"></i>
                        <select id="power-origin" required>
                            <option value="">Selecione a origem dos poderes</option>
                            <option value="acidente">Acidente</option>
                            <option value="alienigena">Alienígena</option>
                            <option value="dadiva">Dádiva</option>
                            <option value="experimento">Experimento</option>
                            <option value="mutante">Mutante</option>
                            <option value="treinamento">Treinamento</option>
                        </select>
                    </div>
                    <div class="description-box" id="origin-description">
                        Selecione uma origem para ver sua descrição...
                    </div>
                </div>

                <div class="actions">
                    <div class="nav-buttons">
                        <button class="btn btn-secondary" id="back-to-identidade">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button class="btn btn-primary" id="avancar-ficha">
                            Avançar para Arquétipos <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBzdrAtJoBUONdyHsEPrzWDTH9FMg1xW78",
            authDomain: "supernova-372bf.firebaseapp.com",
            projectId: "supernova-372bf",
            storageBucket: "supernova-372bf.firebasestorage.app",
            messagingSenderId: "917055386010",
            appId: "1:917055386010:web:3f27d9173e3dd7fbdf8a23"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Descrições detalhadas das origens
        const originDescriptions = {
            'acidente': 'Talvez a origem mais comum de todas. O herói ganha seus poderes por acidente, devido à exposição a alguma força como radiação, químicos, energias místicas fora de controle, ao ser atingido por um raio e assim por diante. Acidentes normalmente são eventos únicos, embora às vezes haja esforços para recriar um acidente para criar superseres deliberadamente. A ciência atual do cenário tende a influenciar origens por acidentes. Heróis da Era de Ouro nos anos 40 muitas vezes ganhavam seus poderes através de acidentes químicos, enquanto heróis da Era de Prata na Era Atômica dos anos 60 ganhavam seus poderes através da radiação e heróis modernos ganham seus poderes através de acidentes envolvendo engenharia genética, nanotecnologia e tecnologias igualmente de ponta.',
            
            'alienigena': 'Um herói pode ser um membro de uma espécie alienígena com poderes incomuns em comparação aos humanos. Ou todos os membros dessa espécie têm poderes semelhantes, ou condições específicas (gravidade mais fraca, radiação solar, etc.) lhes concedem poderes enquanto estão na Terra. Algumas espécies "alienígenas" dos quadrinhos são na verdade descendentes superpoderosos da humanidade vivendo isolados do resto do mundo. "Alienígena" também inclui seres místicos vindos de outras dimensões, de anjos e demônios a elementais e deuses, assim como mestiços mortais descendentes destes. Os poderes de um herói alienígena podem até ter uma origem diferente; ser um alienígena explica apenas parte dos poderes do herói ou é simplesmente um elemento de seu histórico.',
            
            'dadiva': 'Uma força exterior concede poderes ao herói. Pode ser através de uma experiência (veja a próxima entrada), um poder de nível divino, uma organização secreta que distribui mecanismos poderosos, um mago misterioso ou qualquer coisa similar. O patrono pode esperar algo em troca do herói por esta benção, ou o presente pode ser incondicional.',
            
            'experimento': 'Alguns heróis ganham poderes através de um esforço deliberado, através de uma técnica mística ou científica para transformar alguém em um ser superpoderoso. Como no caso dos acidentes, as experiências são quase sempre impossíveis de se duplicar. O herói pode ser um voluntário ou uma vítima escolhida como cobaia para a técnica em questão. Alguns heróis criam seus próprios poderes, tanto desenvolvendo procedimentos capazes de conceder poderes ou construindo seus próprios mecanismos.',
            
            'mutante': 'Um herói pode simplesmente ter nascido "diferente", com o potencial genético para desenvolver superpoderes. Seus poderes latentes normalmente emergem em situações de stress, especialmente durante as mudanças trazidas pela puberdade, embora também possam aparecer como resultado de um acidente (combinando as origens acidente e mutante).',
            
            'treinamento': 'Finalmente, alguns heróis desenvolvem poderes através de trabalho duro e treinamento, seja com rigor físico, estudando técnicas esotéricas de artes marciais, meditação e introspecção para alcançar poderes mentais secretos, ou dominando as artes mágicas. Esse treinamento é normalmente árduo e nem todo mundo tem o potencial necessário para alcançá-lo. Heróis que receberam seus poderes através de treinamento podem ter rivais ou inimigos que treinaram com eles (veja as complicações Inimigo e Rivalidade neste capítulo).'
        };

        // Variáveis globais
        let currentUser = null;
        let currentSlot = null;
        let ageModifier = 0;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeAgeCalculator();
            initializeOriginDescriptions();
            setupNavigation();
            
            // Verificar autenticação
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    const urlParams = new URLSearchParams(window.location.search);
                    currentSlot = urlParams.get('slot');
                    
                    if (!currentSlot) {
                        showMessage('Slot não especificado. Redirecionando...', 'error');
                        setTimeout(() => {
                            window.location.href = 'fichas.html';
                        }, 2000);
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        });

        // Sistema de Abas
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        }

        function switchTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Calculadora de Idade com as faixas específicas
        function initializeAgeCalculator() {
            const ageInput = document.getElementById('character-age');
            
            ageInput.addEventListener('input', updateAgeModifier);
            updateAgeModifier();
        }

        function updateAgeModifier() {
            const age = parseInt(document.getElementById('character-age').value);
            const baseValue = document.getElementById('base-value');
            const ageDescription = document.getElementById('age-description');
            
            // Aplicar as faixas de idade conforme especificado
            if (age <= 6) {
                ageModifier = -4;
                baseValue.textContent = '-4';
                ageDescription.textContent = '-4 (até 6 anos)';
            } else if (age >= 7 && age <= 9) {
                ageModifier = -3;
                baseValue.textContent = '-3';
                ageDescription.textContent = '-3 (7-9 anos)';
            } else if ((age >= 10 && age <= 13) || age >= 70) {
                ageModifier = -2;
                baseValue.textContent = '-2';
                ageDescription.textContent = '-2 (10-13 anos ou +70 anos)';
            } else if (age >= 14 && age <= 17) {
                ageModifier = -1;
                baseValue.textContent = '-1';
                ageDescription.textContent = '-1 (14-17 anos)';
            } else if (age >= 18 && age <= 69) {
                ageModifier = 0;
                baseValue.textContent = '0';
                ageDescription.textContent = '+0 (18-69 anos)';
            }
        }

        // Descrições de Origem
        function initializeOriginDescriptions() {
            const originSelect = document.getElementById('power-origin');
            const originDescription = document.getElementById('origin-description');
            
            originSelect.addEventListener('change', () => {
                const selectedOrigin = originSelect.value;
                if (selectedOrigin && originDescriptions[selectedOrigin]) {
                    originDescription.textContent = originDescriptions[selectedOrigin];
                } else {
                    originDescription.textContent = 'Selecione uma origem para ver sua descrição...';
                }
            });
        }

        // Navegação entre abas
        function setupNavigation() {
            document.getElementById('next-to-origem').addEventListener('click', () => {
                // Validar dados antes de mudar de aba
                if (validateIdentidade()) {
                    switchTab('origem');
                }
            });
            
            document.getElementById('back-to-identidade').addEventListener('click', () => switchTab('identidade'));
            
            document.getElementById('avancar-ficha').addEventListener('click', saveAndContinue);
        }

        // Validar dados da aba Identidade
        function validateIdentidade() {
            const nome = document.getElementById('character-name').value;
            const idade = document.getElementById('character-age').value;
            
            if (!nome.trim()) {
                showMessage('Por favor, preencha o nome do herói.', 'error');
                return false;
            }
            
            if (!idade || idade < 1 || idade > 100) {
                showMessage('Por favor, insira uma idade válida entre 1 e 100 anos.', 'error');
                return false;
            }
            
            return true;
        }

        // Salvar dados e avançar para próxima ficha
        async function saveAndContinue() {
            if (!currentUser || !currentSlot) {
                showMessage('Erro: usuário não autenticado ou slot inválido.', 'error');
                return;
            }

            // Validar dados
            const nome = document.getElementById('character-name').value;
            const alterEgo = document.getElementById('alter-ego').value;
            const idade = document.getElementById('character-age').value;
            const origem = document.getElementById('power-origin').value;

            if (!nome || !origem) {
                showMessage('Por favor, preencha todos os campos obrigatórios (*).', 'error');
                return;
            }

            // Preparar dados do personagem
            const characterData = {
                // Identidade
                nome: nome,
                alterEgo: alterEgo,
                idade: parseInt(idade),
                modificadorIdade: ageModifier,
                
                // Origem
                origem: origem,
                
                // Atributos base com modificador de idade
                atributos: {
                    forca: ageModifier,
                    agilidade: ageModifier,
                    luta: ageModifier,
                    prontidao: ageModifier,
                    vigor: ageModifier,
                    destreza: ageModifier,
                    intelecto: ageModifier,
                    presenca: ageModifier
                },
                
                // Metadados
                userId: currentUser.uid,
                nivel: 1,
                etapaCriacao: 1, // Indica que completou a primeira etapa
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const avancarBtn = document.getElementById('avancar-ficha');
                avancarBtn.disabled = true;
                avancarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                // 1. Criar a ficha na coleção 'fichas'
                const fichaRef = await db.collection('fichas').add(characterData);
                const fichaId = fichaRef.id;

                // 2. Atualizar o usuário com o ID da ficha no slot correto
                await db.collection('usuarios').doc(currentUser.uid).update({
                    [currentSlot]: fichaId
                });

                showMessage('Dados salvos com sucesso! Avançando para próxima etapa...', 'success');

                // Redirecionar para próxima etapa após 2 segundos
                setTimeout(() => {
                    window.location.href = `criarficha2.html?fichaId=${fichaId}&slot=${currentSlot}`;
                }, 2000);

            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showMessage('Erro ao salvar dados. Tente novamente.', 'error');
                
                const avancarBtn = document.getElementById('avancar-ficha');
                avancarBtn.disabled = false;
                avancarBtn.innerHTML = 'Avançar para Ficha <i class="fas fa-arrow-right"></i>';
            }
        }

        // Mostrar mensagem
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>